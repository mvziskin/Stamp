<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STAMP - Silent Video and Photo Capture</title>
    <style>
        /* ... (previous CSS remains unchanged) ... */
    </style>
</head>
<body>
    <!-- ... (previous HTML structure remains unchanged) ... -->

    <script>
        let stream;
        let mediaRecorder;
        let recordedChunks = [];
        let isRecording = false;
        let gpsCoordinates = "Loading...";
        let currentZoom = 1;

        async function initCamera(facingMode = 'environment') {
            try {
                const constraints = {
                    video: {
                        facingMode: facingMode,
                        zoom: currentZoom
                    },
                    audio: false
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                const videoElement = document.getElementById('videoElement');
                videoElement.srcObject = stream;
                videoElement.onloadedmetadata = () => {
                    const canvas = document.getElementById('canvasElement');
                    canvas.width = videoElement.videoWidth;
                    canvas.height = videoElement.videoHeight;
                };
                updateOverlay();
            } catch (err) {
                console.error("Error accessing the camera: ", err);
                alert("Error accessing the camera: " + err.message);
            }
        }

        // ... (other functions remain unchanged) ...

        function startRecording() {
            recordedChunks = [];
            const canvas = document.getElementById('canvasElement');
            const stream = canvas.captureStream(30); // 30 FPS, no audio

            const options = { mimeType: 'video/webm' };
            try {
                mediaRecorder = new MediaRecorder(stream, options);
            } catch (e) {
                console.error("Error creating MediaRecorder:", e);
                alert("Error creating MediaRecorder: " + e.message);
                return;
            }

            mediaRecorder.ondataavailable = handleDataAvailable;
            mediaRecorder.onstop = saveVideo;
            mediaRecorder.onerror = (event) => {
                console.error("MediaRecorder error:", event.error);
                alert("MediaRecorder error: " + event.error);
            };

            try {
                mediaRecorder.start();
                console.log("MediaRecorder started", mediaRecorder.state);
            } catch (e) {
                console.error("Error starting MediaRecorder:", e);
                alert("Error starting MediaRecorder: " + e.message);
            }
        }

        function handleDataAvailable(event) {
            console.log("Data available:", event.data.size);
            if (event.data && event.data.size > 0) {
                recordedChunks.push(event.data);
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== "inactive") {
                mediaRecorder.stop();
                console.log("MediaRecorder stopped", mediaRecorder.state);
            }
        }

        function saveVideo() {
            console.log("Saving video, chunks:", recordedChunks.length);
            if (recordedChunks.length === 0) {
                console.error("No recorded chunks to save");
                alert("No video data recorded");
                return;
            }

            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const videoUrl = URL.createObjectURL(blob);
            const video = document.createElement('video');
            video.src = videoUrl;
            video.muted = true;
            video.controls = true;
            video.onloadedmetadata = () => {
                console.log("Video duration:", video.duration);
            };
            document.getElementById('gallery').prepend(video);
        }

        // ... (other functions remain unchanged) ...

        // Initialize the camera and GPS when the page loads
        window.onload = () => {
            initCamera();
            getGPSLocation();
            setInterval(getGPSLocation, 10000);
        };
    </script>
</body>
</html>
